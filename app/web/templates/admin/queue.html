{% extends "admin/layout.html" %}

{% block admin_content %}
<div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
    <h3 class="font-display text-xl font-bold">Processing Queue</h3>
    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full sm:w-auto">
        <!-- Auto-Refresh Controls -->
        <div
            class="flex items-center text-sm bg-surface-base px-3 py-2 rounded-xl border border-white/[0.08] justify-between sm:justify-start">
            <label class="flex items-center cursor-pointer mr-3">
                <input type="checkbox" id="auto-refresh-toggle" checked
                    class="rounded border-white/20 bg-surface-base text-primary-500 focus:ring-primary-500 mr-2 w-4 h-4">
                <span class="font-medium text-text-secondary">Auto</span>
            </label>
            <div class="flex items-center">
                <input type="number" id="refresh-interval" value="30" min="5" max="300"
                    class="w-10 text-center border-none bg-transparent focus:ring-0 p-0 font-bold text-primary-400 appearance-none"
                    style="-moz-appearance: textfield;">
                <span class="mr-2 text-text-muted">s</span>
                <span
                    class="text-xs font-mono font-bold bg-primary-500/20 text-primary-400 px-2.5 py-1 rounded-full min-w-[3rem] text-center"
                    id="refresh-countdown">30s</span>
            </div>
        </div>

        <a href="/admin/queue" class="btn-secondary btn-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                </path>
            </svg>
            Refresh
        </a>
    </div>
</div>

{% if queue %}
<div class="overflow-x-auto rounded-xl border border-white/[0.06]">
    <table class="table-dark">
        <thead>
            <tr>
                <th>Status</th>
                <th>Podcast</th>
                <th>Episode</th>
                <th>Progress</th>
                <th class="text-right">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in queue %}
            <tr>
                <td class="whitespace-nowrap">
                    {% if item.status == 'processing' %}
                    <span class="badge-info animate-pulse">Processing</span>
                    {% elif item.status == 'pending' %}
                    <span class="badge-neutral">Pending</span>
                    {% elif item.status == 'failed' %}
                    <span class="badge-error" title="Retry scheduled: {{ item.next_retry_at }}">Retry Pending</span>
                    {% endif %}
                </td>
                <td class="whitespace-nowrap text-text-secondary font-medium">
                    {{ item.podcast_title }}
                </td>
                <td class="max-w-md">
                    <div class="truncate" title="{{ item.title }}">{{ item.title }}</div>
                </td>
                <td class="whitespace-nowrap">
                    {% if item.status == 'processing' %}
                    <div class="flex flex-col min-w-[12rem]">
                        <span class="text-xs font-bold text-primary-400 mb-1.5">{{ item.processing_step }}</span>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: {{ item.progress }}%"></div>
                        </div>
                    </div>
                    {% else %}
                    <span class="text-xs text-text-muted">-</span>
                    {% endif %}
                </td>
                <td class="whitespace-nowrap text-right">
                    {% if item.status == 'processing' %}
                    <form action="/admin/queue/cancel/{{ item.id }}" method="post" class="inline">
                        <button type="submit" class="text-red-400 hover:text-red-300 transition font-bold text-sm"
                            onclick="return confirm('Stop processing this episode?')">
                            Cancel
                        </button>
                    </form>
                    {% else %}
                    <form action="/admin/queue/retry/{{ item.id }}" method="post" class="inline">
                        <button type="submit"
                            class="text-primary-400 hover:text-primary-300 transition font-bold text-sm">
                            {% if item.status == 'failed' %}Retry Now{% else %}Process Now{% endif %}
                        </button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center py-16 rounded-xl border-2 border-dashed border-white/[0.1]">
    <svg class="mx-auto h-14 w-14 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <h3 class="mt-4 text-base font-semibold">Queue is empty</h3>
    <p class="mt-2 text-sm text-text-muted">No episodes are currently processing or pending.</p>
</div>
{% endif %}

<script>
    (function () {
        const toggle = document.getElementById('auto-refresh-toggle');
        const intervalInput = document.getElementById('refresh-interval');
        const countdownDisplay = document.getElementById('refresh-countdown');

        const savedInterval = localStorage.getItem('queue-refresh-interval');
        const savedToggle = localStorage.getItem('queue-refresh-enabled');

        if (savedInterval) intervalInput.value = savedInterval;
        if (savedToggle !== null) toggle.checked = savedToggle === 'true';

        let timeLeft = parseInt(intervalInput.value);
        let intervalId = null;

        function updateCountdown() {
            if (!toggle.checked) return;
            timeLeft--;
            if (timeLeft <= 0) {
                localStorage.setItem('queue-refresh-enabled', toggle.checked);
                localStorage.setItem('queue-refresh-interval', intervalInput.value);
                window.location.reload();
            } else {
                countdownDisplay.textContent = timeLeft + 's';
            }
        }

        function startTimer() {
            if (intervalId) clearInterval(intervalId);
            timeLeft = parseInt(intervalInput.value);
            if (isNaN(timeLeft) || timeLeft < 5) timeLeft = 5;
            countdownDisplay.textContent = timeLeft + 's';
            if (toggle.checked) {
                intervalId = setInterval(updateCountdown, 1000);
                countdownDisplay.classList.remove('bg-white/5', 'text-text-muted');
                countdownDisplay.classList.add('bg-primary-500/20', 'text-primary-400');
            } else {
                countdownDisplay.textContent = 'Off';
                countdownDisplay.classList.remove('bg-primary-500/20', 'text-primary-400');
                countdownDisplay.classList.add('bg-white/5', 'text-text-muted');
            }
        }

        toggle.onchange = function () {
            localStorage.setItem('queue-refresh-enabled', toggle.checked);
            startTimer();
        };

        intervalInput.onchange = function () {
            let val = parseInt(this.value);
            if (isNaN(val) || val < 5) { val = 5; this.value = 5; }
            if (val > 300) { val = 300; this.value = 300; }
            localStorage.setItem('queue-refresh-interval', val);
            startTimer();
        };

        startTimer();
    })();
</script>
{% endblock %}